### 1. 目的

Javaで生成されるデータベースアクセスコードに、アプリケーションレベルの行レベルセキュリティ（RLS）機能を導入する。これにより、マルチテナントのような要件に対応し、ユーザーの権限に基づいてアクセス可能なデータ行を制限する。

### 2. 背景

現状のコード生成ツールでは、生成されたJavaコードにデータアクセス制御の仕組みが存在しない。そのため、特定のカラムの値（例：部署コード）に基づいて、ユーザーが表示・操作できるデータを制限したいという要件に対応できない。この改修では、データベースのRLS機能に依存せず、Javaアプリケーション側でこの制御を実現する。

### 3. 実装方針

RLSの実現のために、UIの改修とJavaコード生成ロジックの改修を行う。

#### 3.1. UI (`index.html`) の変更

*   **RLS設定項目の追加**:
    *   RLS機能を有効化するためのチェックボックスを設ける。
    *   RLSの制御に使用するカラム名を指定するための入力フィールドを追加する。
        *   **テナントIDカラム**: ユーザーの所属を識別するカラム名（例: `department_code`）。
        *   **管理者フラグカラム**: 全てのデータへのアクセスを許可する権限を持つかどうかを示す`boolean`型のカラム名（例: `is_admin`）。
*   **設定の適用**:
    *   これらの設定は、コード生成時にJavaコードに反映される。

#### 3.2. Javaコード生成ロジックの変更

*   **`SessionInfo` クラスの導入**:
    *   現在のユーザー情報（テナントIDや管理者フラグ）を保持する`SessionInfo`クラスを新たに生成する。
    *   このクラスは、アプリケーションでDI（Dependency Injection）コンテナによってリクエストスコープで管理されることを想定する。

*   **マーカーインターフェースの導入**:
    *   RLSの対象となるテーブルのModelクラスに実装させるためのマーカーインターフェース（例: `RlsAware`）を生成する。
    *   このインターフェースには、テナントIDを取得するための`getter`メソッドを定義させる。

*   **`BaseRepository` の機能拡張**:
    *   全てのRepositoryクラスが継承する`BaseRepository`（または新たに作成する`RlsRepository`）に、RLSフィルタリング機能を追加する。
    *   `find`や`findAll`などの検索処理の起点となるメソッド（例: `finder()`）を設ける。
    *   このメソッド内で、現在の`SessionInfo`を元にアクセス制御の条件（WHERE句）を動的に組み立てる。
        *   **管理者ユーザーの場合**: 条件を追加せず、全てのレコードを対象とする。
        *   **一般ユーザーの場合**: `SessionInfo`から取得したテナントIDと、ModelのテナントIDカラムが一致するレコードのみを対象とする条件を追加する。
        *   **RLS対象外テーブルの場合**: Modelが`RlsAware`インターフェースを実装していない場合は、条件を追加しない。

*   **生成される `Repository` / `Service` の変更**:
    *   `Service`クラスは`SessionInfo`をコンストラクタで受け取るように変更する。
    *   `Repository`クラスは、検索時に`BaseRepository`のRLSフィルタリングメソッドを利用するように変更する。

### 4. 実装タスク

1.  **UIの改修**: `index.html`にRLS設定用のフォームを追加する。
2.  **JavaScriptの改修**: UIで入力されたRLS設定値を取得し、コード生成ロジックに渡す処理を追加する。
3.  **Javaコード生成ロジックの改修**:
    *   `SessionInfo.java`を生成する処理を追加。
    *   `RlsAware.java`インターフェースを生成する処理を追加。
    *   `BaseRepository.java`にRLSフィルタリングロジックを追加。
    *   各テーブルのModelクラス生成時に、テナントIDカラムが存在すれば`RlsAware`インターフェースを実装させる。
    *   各テーブルの`Repository`クラスが`BaseRepository`のRLS機能を利用するように修正。
4.  **動作確認**: 生成されたコードが、想定通りにRLSのアクセス制御を行えるかを確認する。
