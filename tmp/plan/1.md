# テーブル定義変換ツール作成計画

## 1. 概要

指定されたTSV/CSVフォーマットのテーブル定義ファイルを読み込み、またはテキストエリアに貼り付けられた内容を元に、以下の形式に変換するWebアプリケーション（シングルページのHTML+JavaScript）を開発する。

- DDL (PostgreSQL)
- TypeScript の `type`
- Java (EBean) の `model`
- Java の `repository`
- Java の `service`

## 2. 機能要件

### 2.1. 入力

- TSVまたはCSV形式のファイルを選択してアップロードできる。
- **テキストエリアにTSVまたはCSV形式のデータを直接貼り付けて入力できる。**
- ファイルエンコーディングはUTF-8を前提とする。

### 2.2. 変換

- アップロードまたは入力されたテーブル定義を元に、指定されたフォーマットへの変換を実行する。
- 変換対象のフォーマットはチェックボックス等で複数選択できる。

### 2.3. 出力

- 変換結果を画面上のテキストエリアに表示する。フォーマットごとにタブで切り替えられるようにする。
- 変換結果をファイルとしてダウンロードできる。
- 複数のファイル形式を選択した場合、生成されるファイルをZIP形式にまとめてダウンロードできる。

### 2.4. 各変換形式の詳細要件

#### 2.4.1. DDL (PostgreSQL)

- `CREATE TABLE` 文を生成する。
- `COMMENT ON TABLE` と `COMMENT ON COLUMN` を使用して、テーブルとカラムの日本語名を設定する。
- `PRIMARY KEY`, `UNIQUE`, `NOT NULL` 制約を定義する。
- `DEFAULT` 値を設定する。
- 複数の `AK` が指定されている場合、それらをまとめた `UNIQUE` 制約を追加する。
- `Idx1` から `Idx5` の定義に基づき `CREATE INDEX` 文を生成する。
- ロールバック用に `DROP TABLE IF EXISTS` 文を生成する。

#### 2.4.2. TypeScript `type`

- テーブルごとに `export type` を生成する。
- JSDoc形式でテーブルの日本語名とカラムの日本語名をコメントとして付与する。
- PostgreSQLのデータ型を適切なTypeScriptの型にマッピングする。
  - `bigint`, `bigserial`, `integer`, `smallint` -> `number`
  - `varchar`, `char`, `text` -> `string`
  - `boolean` -> `boolean`
  - `date`, `time`, `timestamp` -> `string` (or `Date`)
  - `bytea` -> `string`
  - `bit` -> `string`

#### 2.4.3. Java (EBean) `model`

- テーブルごとにEBeanモデルのJavaクラスファイルを生成する。
- `BaseModel.java` は固定のテンプレートとして用意し、生成される各モデルクラスはこれを継承する。
- Lombokのアノテーション (`@Getter`, `@Setter`) とEBeanのアノテーション (`@Entity`, `@Table`) を付与する。
- JavaDocでカラムの日本語名をコメントとして付与する。
- PostgreSQLのデータ型を適切なJavaの型にマッピングする。
  - `bigint`, `bigserial`, `integer`, `smallint` -> `Long` or `Integer`
  - `varchar`, `char`, `text` -> `String`
  - `boolean` -> `Boolean`
  - `date`, `time`, `timestamp` -> `java.time.Instant` or `java.time.LocalDate` etc.
  - `bytea` -> `byte[]`
  - `bit` -> `String`
- クラスの末尾に `Finder` を定義する。

#### 2.4.4. Java `repository`

- テーブルごとにRepositoryのJavaクラスファイルを生成する。
- サンプルに基づき、基本的なCRUD操作（`findById`, `findAll`, `insert`, `update`, `delete`）のメソッドを実装する。
- `AK`（代理キー）に基づいた `findBy...` メソッドを生成する。
- JavaDocで各メソッドの説明を付与する。
- `delete` メソッドは `isDeleted` カラムを `true` に更新する論理削除として実装する。
- `find` 系のメソッドには `isDeleted = false` の条件をデフォルトで付与する。
- `update` メソッドでは `updatedAt` を利用した排他制御を考慮する（ただし、具体的な実装はEBeanの `@WhenModified` に任せるため、コード上は意識しない）。

#### 2.4.5. Java `service`

- テーブルごとにServiceのJavaクラスファイルを生成する。
- 対応する `Repository` クラスに依存するコンストラクタを生成する。
- `find` メソッドでは、Repositoryから取得したリストをJSON (`ObjectNode`) に変換する処理を含める。
- `findById`, `create`, `update`, `delete` など、Repositoryのメソッドを呼び出す基本的なメソッドを実装する。
- `exportCsv` メソッドの雛形を生成する。ヘッダーと `rowMapper` の部分はテーブル定義に基づいて自動生成する。
- `importCsv` メソッドの雛形を生成する。ファイル読み込みと基本的なバリデーション（ヘッダー、カラム数）のコードを含める。業務ロジックに関わる詳細なバリデーション部分はコメント等で追記を促す形とする。
- 全てのメソッドは非同期処理を前提とし、`CompletionStage` を戻り値とする。

## 3. 画面設計 (UI)

- **ヘッダー**: アプリケーションのタイトル
- **入力エリア**:
  - ファイル入力とテキストエリア入力を切り替えるタブUI
  - **ファイル入力タブ**: ファイル選択ボタン (`<input type="file">`) と読み込んだファイル名を表示するエリア
  - **テキストエリアタブ**: TSV/CSVを貼り付けるための `<textarea>`
- **オプションエリア**:
  - 変換先フォーマットを選択するチェックボックス (DDL, TypeScript, Java Model, Java Repository, Java Service)
- **コントロールエリア**:
  - 「変換実行」ボタン
- **結果表示エリア**:
  - 変換結果をフォーマットごとに表示するためのタブUI
  - 各タブ内に、生成されたコードを表示するテキストエリア
  - 「ダウンロード」ボタン（選択中のタブの内容をダウンロード）
  - 「すべてダウンロード (ZIP)」ボタン

## 4. 実装計画

### フェーズ1: 基本構造の構築

1.  **HTML/CSS**:
    - 上記UI設計に基づいた基本的なHTML構造を作成する。
    - 見た目を整えるため、軽量なCSSフレームワーク（例: Bootstrap, Pico.css）をCDN経由で利用する。
2.  **入力処理**:
    - `FileReader` APIを使用して、選択されたTSV/CSVファイルをテキストとして読み込む。
    - テキストエリアから直接テキストを取得する。
    - PapaParseライブラリ（CDN）を利用してTSV/CSVをパースし、JavaScriptのオブジェクト配列に変換する。

### フェーズ2: 変換ロジックの実装

3.  **中間データ構造の定義**:
    - パースしたデータを扱いやすいように、テーブルごとの情報（テーブル名、カラムリスト、インデックス情報など）をまとめた中間データ構造を定義する。
4.  **DDL変換ロジック**:
    - 中間データ構造を元に、PostgreSQLのDDL文字列を生成する関数を実装する。
5.  **TypeScript変換ロジック**:
    - 中間データ構造を元に、TypeScriptの`type`定義文字列を生成する関数を実装する。
6.  **Java Model変換ロジック**:
    - 中間データ構造を元に、JavaのModelクラス定義文字列を生成する関数を実装する。
7.  **Java Repository変換ロジック**:
    - 中間データ構造を元に、JavaのRepositoryクラス定義文字列を生成する関数を実装する。
8.  **Java Service変換ロジック**:
    - 中間データ構造を元に、JavaのServiceクラス定義文字列を生成する関数を実装する。

### フェーズ3: 結果表示とダウンロード機能

9.  **UI連携**:
    - 「変換実行」ボタンクリック時に、各変換ロジックを実行し、結果を対応するタブのテキストエリアに表示する。
10. **ダウンロード機能**:
    - 「ダウンロード」ボタンで、表示中のテキストエリアの内容をテキストファイルとしてダウンロードする機能を実装する。
11. **ZIPダウンロード機能**:
    - JSZipライブラリ（CDN）を利用する。
    - 「すべてダウンロード (ZIP)」ボタンクリック時に、選択されたすべてのフォーマットのファイルを生成し、ZIPにまとめてダウンロードする機能を実装する。

## 5. ツール・ライブラリ

- **CSS Framework**: Pico.css (シンプルで軽量なため)
- **CSV/TSV Parser**: PapaParse (信頼性が高く多機能なため)
- **ZIP Archiver**: JSZip (クライアントサイドでのZIP生成のデファクトスタンダード)

すべてCDN経由で利用し、単一のHTMLファイルにまとめるという要件を満たす。
