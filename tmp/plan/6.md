# 実装計画: Javaリポジトリに件数取得メソッドを追加

## 概要

Java の repository, service の自動生成処理を修正し、List を返す `find`, `findAll` メソッドに対応する、件数を取得するための `count` メソッドを追加する。
これにより、特にページネーションを実装する際に、全件数を効率的に取得できるようになる。

## 計画

### 1. `generateJavaRepo` 関数の修正 (`index.html`)

`index.html` 内の `generateJavaRepo` JavaScript 関数に、以下のメソッド生成ロジックを追加する。

#### 1.1. `countAll` メソッドの追加

`findAll` メソッドに対応する、フィルタ条件なしの全件数を取得するメソッドを追加する。

- **場所**: `findAll(int offset, int limit)` メソッドの直後。
- **生成するメソッド (Java)**:
  ```java
  /**
   * 全ての ${table.tableNameJP} の件数を取得します（論理削除済みは除く）。
   * @return 件数
   */
  public CompletionStage<Integer> countAll() {
      return supplyAsync(() ->
          DB.find(${modelName}.class)
              .where()
              .eq("isDeleted", false)
              .findCount()
      , executionContext);
  }
  ```

#### 1.2. `count(filter)` メソッドの追加

`find(filter, ...)` メソッドに対応する、フィルタ条件付きの件数を取得するメソッドを追加する。

- **場所**: `find(${modelName} filter, int offset, int limit)` メソッドの直後。
- **生成するメソッド (Java)**:
  ```java
  /**
   * ${table.tableNameJP} の件数を検索条件に基づいて取得します（論理削除済みは除く）。
   * @param filter 検索条件
   * @return 件数
   */
  public CompletionStage<Integer> count(${modelName} filter) {
      return supplyAsync(() -> {
          io.ebean.ExpressionList<${modelName}> query = DB.find(${modelName}.class).where().eq("isDeleted", false);

          // find メソッドと同様の条件分岐をここにも生成する
          // ... (if (filter.get... != null) { ... })

          return query.findCount();
      }, executionContext);
  }
  ```

### 2. `generateJavaService` 関数の修正 (`index.html`)

`index.html` 内の `generateJavaService` JavaScript 関数を修正し、リポジトリに追加した `count` メソッドを呼び出すように変更する。
これにより、Service が返す JSON オブジェクトの `total` プロパティが、ページ内の件数ではなく、全体の総件数を示すようになり、より正確になる。

#### 2.1. `find(int offset, int limit)` メソッドの修正

- **変更前**:
  ```javascript
  classContent += `        return ${repoVar}.findAll(offset, limit).thenApply(list -> {
`;
  classContent += `            ObjectNode result = Json.newObject();
`;
  classContent += `            result.put("total", list.size()); // <-- ページ内の件数になっている
`;
  classContent += `            result.set("data", Json.toJson(list));
`;
  classContent += `            return result;
`;
  classContent += `        });
`;
  ```
- **変更後**:
  ```javascript
  classContent += `        CompletionStage<Integer> totalFuture = ${repoVar}.countAll();
`;
  classContent += `        CompletionStage<List<${modelName}>> dataFuture = ${repoVar}.findAll(offset, limit);
`;
  classContent += `        return totalFuture.thenCombine(dataFuture, (total, data) -> {
`;
  classContent += `            ObjectNode result = Json.newObject();
`;
  classContent += `            result.put("total", total);
`;
  classContent += `            result.set("data", Json.toJson(data));
`;
  classContent += `            return result;
`;
  classContent += `        });
`;
  ```

#### 2.2. `find(filter, int offset, int limit)` メソッドの修正

- **変更前**:
  ```javascript
  classContent += `        return ${repoVar}.find(filter, offset, limit).thenApply(list -> {
`;
  classContent += `            ObjectNode result = Json.newObject();
`;
  classContent += `            result.put("total", list.size()); // <-- ページ内の件数になっている
`;
  classContent += `            result.set("data", Json.toJson(list));
`;
  classContent += `            return result;
`;
  classContent += `        });
`;
  ```
- **変更後**:
  ```javascript
  classContent += `        CompletionStage<Integer> totalFuture = ${repoVar}.count(filter);
`;
  classContent += `        CompletionStage<List<${modelName}>> dataFuture = ${repoVar}.find(filter, offset, limit);
`;
  classContent += `        return totalFuture.thenCombine(dataFuture, (total, data) -> {
`;
  classContent += `            ObjectNode result = Json.newObject();
`;
  classContent += `            result.put("total", total);
`;
  classContent += `            result.set("data", Json.toJson(data));
`;
  classContent += `            return result;
`;
  classContent += `        });
`;
  ```
