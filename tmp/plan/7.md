# 実装計画: Javaリポジトリのクエリ生成ロジック共通化

## 概要

`index.html` の `generateJavaRepo` 関数を修正し、Java リポジトリクラス内に生成される `find` メソッドと `count` メソッドのクエリ構築ロジックを共通化する。
現在、両方のメソッド内でフィルタ条件を元に `io.ebean.ExpressionList` を構築するコードが重複している。これをプライベートなヘルパーメソッドに切り出すことで、コードの重複を排除し、保守性を向上させる。

## 計画

### 1. `generateJavaRepo` 関数の修正 (`index.html`)

#### 1.1. プライベートヘルパーメソッド `createQueryWithFilter` の生成ロジックを追加

フィルタオブジェクトを受け取り、条件式 (`ExpressionList`) を構築して返すプライベートメソッドを生成するロジックを追加する。

- **場所**: `count(${modelName} filter)` メソッドの直後が適切。
- **生成するメソッド (Java)**:
  ```java
  /**
   * 検索条件に基づいてクエリを構築します。
   * @param filter 検索条件
   * @return 構築されたクエリ
   */
  private io.ebean.ExpressionList<${modelName}> createQueryWithFilter(${modelName} filter) {
      io.ebean.ExpressionList<${modelName}> query = DB.find(${modelName}.class).where().eq("isDeleted", false);

      // 現在 find/count メソッド内にある条件分岐ロジックをここに移動する
      // ... (if (filter.get... != null) { ... })

      return query;
  }
  ```

#### 1.2. `find(${modelName} filter, ...)` メソッドの修正

`find` メソッド内のクエリ構築ロジックを、新しく作成する `createQueryWithFilter` メソッドの呼び出しに置き換える。

- **変更前**:
  ```javascript
  classContent += `    public CompletionStage<List<${modelName}>> find(${modelName} filter, int offset, int limit) {
`;
  classContent += `        return supplyAsync(() -> {
`;
  classContent += `            io.ebean.ExpressionList<${modelName}> query = DB.find(${modelName}.class).where().eq("isDeleted", false);

`;
  // ... (クエリ構築ロジック) ...
  classContent += `
            return query.setFirstRow(offset).setMaxRows(limit).findList();
`;
  classContent += `        }, executionContext);
`;
  classContent += `    }

`;
  ```
- **変更後**:
  ```javascript
  classContent += `    public CompletionStage<List<${modelName}>> find(${modelName} filter, int offset, int limit) {
`;
  classContent += `        return supplyAsync(() ->
`;
  classContent += `            createQueryWithFilter(filter)
`;
  classContent += `                .setFirstRow(offset)
`;
  classContent += `                .setMaxRows(limit)
`;
  classContent += `                .findList()
`;
  classContent += `        , executionContext);
`;
  classContent += `    }

`;
  ```

#### 1.3. `count(${modelName} filter)` メソッドの修正

`count` メソッド内のクエリ構築ロジックも同様に、`createQueryWithFilter` メソッドの呼び出しに置き換える。

- **変更前**:
  ```javascript
  classContent += `    public CompletionStage<Integer> count(${modelName} filter) {
`;
  classContent += `        return supplyAsync(() -> {
`;
  classContent += `            io.ebean.ExpressionList<${modelName}> query = DB.find(${modelName}.class).where().eq("isDeleted", false);

`;
  // ... (クエリ構築ロジック) ...
  classContent += `
            return query.findCount();
`;
  classContent += `        }, executionContext);
`;
  classContent += `    }

`;
  ```
- **変更後**:
  ```javascript
  classContent += `    public CompletionStage<Integer> count(${modelName} filter) {
`;
  classContent += `        return supplyAsync(() ->
`;
  classContent += `            createQueryWithFilter(filter).findCount()
`;
  classContent += `        , executionContext);
`;
  classContent += `    }

`;
  ```
